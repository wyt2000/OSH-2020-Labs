# Lab3 Report

## PB18111684 吴钰同

### 完善双人聊天室

#### 实现以换行为分隔符的消息分割

在三个程序中，我都采用了如下方法：每次 `recv` 一个字符并把它存到字符数组或 `std::string` 中，判断这个字符是否为换行符；如果是，就让当前的字符数组或`std::string` 直接发送或进入发送队列。

#### 处理可能的 `send` 阻塞

实际上，即使是非阻塞的 `send` ，正常情况下我也没有遇到无法全部发送 1MiB 信息的情况。为了测试，我手动改小了缓冲区。

处理方法是检测 `send` 的返回值，如果比要发送的信息的长度小，说明没发完，将要发送的信息改为原来字符串的对应子串再重新发送。

### 利用多线程技术实现多人聊天室

按照助教在习题课上讲的方法进行了修改。

当接收进程接收到`'\n'`时，把其他客户端的 `mutex`  锁住，向它们的发送队列里添加消息，然后给其他客户端的发送进程发送信号，再解锁。当发送进程收到信号时，从发送队列里取出消息，然后解锁，最后向客户端发送消息。

`log_thread` 线程用于处理用户的登出。

### 利用 IO 复用 / 异步 IO 技术实现多人聊天室

按照助教在习题课上讲的方法进行了修改。

用 `select` 找出可接收和可发送的文件描述符，对于每一个可接收的文件描述符，接收消息到 `\n`，再分别向其他客户端的发送队列里添加消息；对于每一个可发送的文件描述符，如果发送队列非空，就发送队列里的消息，如果没发完，就把剩下的消息再塞回队列。

### 其他

- 用户登陆和登出时，会在标准输出打印提示。

